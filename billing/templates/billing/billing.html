{% extends 'base.html' %}

{% block title %}Billing - Create New Bill{% endblock %}

{% block extra_css %}
<style>
    .product-suggestions {box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    
    .product-suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .product-suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .product-suggestion-item.selected {
        background-color: #007bff;
        color: white;
    }
    
    .product-suggestion-item .product-id {
        font-weight: bold;
        color: #007bff;
    }
    
    .product-suggestion-item .product-name {
        font-size: 13px;
        margin: 2px 0;
    }
    
    .product-suggestion-item .product-details {
        font-size: 11px;
        color: #666;
    }
    
    .product-search-container {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Create New Bill</h4>
            </div>
            <div class="card-body">
                <form id="billingForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label>Customer Email *</label>
                        {{ form.customer_email }}
                    </div>

                    <div class="mb-3">
                        <h5>Products</h5>
                        <div id="product-container">
                            <div class="product-row" data-index="0">
                                <div class="row">
                                    <div class="col-md-5">
                                        <label>Product</label>
                                        <input type="text" class="form-control product-search" name="product_search_0" placeholder="Search product..." autocomplete="off">
                                        <input type="hidden" class="product-id-input" name="product_id_0" value="">
                                        <div class="product-suggestions" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; width: 100%;"></div>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Qty</label>
                                        <input type="number" class="form-control quantity-input" name="quantity_0" min="1" value="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label>Price</label>
                                        <input type="text" class="form-control unit-price" readonly>
                                    </div>
                                    <div class="col-md-1">
                                        <label>&nbsp;</label><br>
                                        <button type="button" class="btn btn-danger btn-sm remove-product">×</button>
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-md-12">
                                        <small class="text-muted product-details"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-product" class="btn btn-primary btn-sm mt-2">+ Add Product</button>
                    </div>

                    <div class="mb-3">
                        <h5>Customer Payment</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Denomination</label>
                            </div>
                            <div class="col-md-6">
                                <label>Count</label>
                            </div>
                        </div>
                        {% for denomination in denominations %}
                        <div class="row mb-1">
                            <div class="col-md-6">
                                <label>₹{{ denomination.value }}</label>
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control form-control-sm customer-denomination-count" 
                                       data-value="{{ denomination.value }}" value="0" min="0">
                            </div>
                        </div>
                        {% endfor %}
                        <div class="alert alert-info mt-2">
                            <strong>Total: <span id="customer-total-payment">₹0.00</span></strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>Amount Paid *</label>
                        {{ form.amount_paid }} 
                    </div>

                    <button type="submit" class="btn btn-success">Generate Bill</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Shop Drawer</h5>
            </div>
            <div class="card-body">
                {% for denomination in denominations %}
                <div class="row mb-1">
                    <div class="col-6">
                        <label>₹{{ denomination.value }}</label>
                    </div>
                    <div class="col-6">
                        <input type="number" class="form-control form-control-sm denomination-count" 
                               data-value="{{ denomination.value }}" value="{{ denomination.count }}" min="0">
                    </div>
                </div>
                {% endfor %}
                <hr>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="showDrawerStatus()">View Status</button>
                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="refreshDrawerFromDatabase()">Refresh</button>
                <div class="mt-2">
                    <small class="text-info"><span id="drawer-status-indicator">Ready</span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> Invoice Generated
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoice-content">
                <!-- Invoice content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let productIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize product search for existing product inputs
    initializeProductSearch();
    
    document.getElementById('add-product').addEventListener('click', addProduct);
    document.querySelectorAll('.product-row').forEach(setupProductRowEvents);
    setupDenominationEvents();
    document.getElementById('billingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateBill();
    });
});

function initializeProductSearch() {
    document.querySelectorAll('.product-search').forEach(function(input) {
        setupProductSearch(input);
    });
}

function setupProductSearch(input) {
    let searchTimeout;
    let selectedIndex = -1;
    let suggestions = [];
    
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 1) {
            hideSuggestions(input);
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchProducts(query, input);
        }, 300);
    });
    
    input.addEventListener('keydown', function(e) {
        const suggestionsDiv = input.parentNode.querySelector('.product-suggestions');
        const items = suggestionsDiv.querySelectorAll('.product-suggestion-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items, selectedIndex);
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items, selectedIndex);
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    selectProduct(items[selectedIndex], input);
                }
                break;
            case 'Escape':
                hideSuggestions(input);
                break;
        }
    });
    
    input.addEventListener('blur', function() {
        setTimeout(() => {
            hideSuggestions(input);
        }, 200);
    });
}

function searchProducts(query, input) {
    fetch(`/api/search-products/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            suggestions = data.products || [];
            showSuggestions(suggestions, input);
        })
        .catch(error => {
            console.error('Error searching products:', error);
        });
}

function showSuggestions(products, input) {
    const suggestionsDiv = input.parentNode.querySelector('.product-suggestions');
    suggestionsDiv.innerHTML = '';
    
    if (products.length === 0) {
        suggestionsDiv.innerHTML = '<div class="product-suggestion-item">No products found</div>';
    } else {
        products.forEach(product => {
            const item = document.createElement('div');
            item.className = 'product-suggestion-item';
            item.innerHTML = `
                <div class="product-id">${product.id}</div>
                <div class="product-name">${product.name}</div>
                <div class="product-details">₹${product.price} | ${product.tax}% | Stock: ${product.stock}</div>
            `;
            function handleSuggestionSelect(e) {
                selectProduct(item, input, product);
            }
            item.addEventListener('mousedown', handleSuggestionSelect);
            item.addEventListener('click', handleSuggestionSelect);
            suggestionsDiv.appendChild(item);
        });
    }
    
    suggestionsDiv.style.display = 'block';
}

function hideSuggestions(input) {
    const suggestionsDiv = input.parentNode.querySelector('.product-suggestions');
    suggestionsDiv.style.display = 'none';
}

function updateSelection(items, selectedIndex) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function selectProduct(item, input, product) {
    if (product) {
        input.value = `${product.id} - ${product.name}`;
        input.parentNode.querySelector('.product-id-input').value = product.id;
        
        // Update price and details
        const row = input.closest('.product-row');
        const unitPriceInput = row.querySelector('.unit-price');
        const productDetails = row.querySelector('.product-details');
        
        unitPriceInput.value = `₹${product.price}`;
        productDetails.textContent = `${product.name} | Tax: ${product.tax}% | Stock: ${product.stock}`;
    }
    
    hideSuggestions(input);
}

function formatProductOption(product) {
    if (!product.id) return product.text;
    return $(`<div class="product-option">
        <div class="product-id">${product.id}</div>
        <div class="product-name">${product.name}</div>
        <div class="product-details"><small>₹${product.price} | ${product.tax}% | Stock: ${product.stock}</small></div>
    </div>`);
}

function formatProductSelection(product) {
    return product.id ? `${product.id} - ${product.name}` : product.text;
}

function addProduct() {
    productIndex++;
    const container = document.getElementById('product-container');
    const newProductRow = container.querySelector('.product-row').cloneNode(true);
    
    newProductRow.dataset.index = productIndex;
    newProductRow.querySelectorAll('input').forEach(field => {
        if (field.name) {
            field.name = field.name.replace(/_\d+/, '_' + productIndex);
        }
        if (field.type !== 'button') {
            field.value = field.type === 'number' ? '1' : '';
        }
    });
    
    container.appendChild(newProductRow);
    setupProductRowEvents(newProductRow);
    
    // Initialize product search for the new product input
    const newProductSearch = newProductRow.querySelector('.product-search');
    if (newProductSearch) {
        setupProductSearch(newProductSearch);
    }
}

function setupProductRowEvents(row) {
    const productSearch = row.querySelector('.product-search');
    const productIdInput = row.querySelector('.product-id-input');
    const unitPriceInput = row.querySelector('.unit-price');
    const productDetails = row.querySelector('.product-details');
    
    // Handle product search input change
    productSearch.addEventListener('input', function() {
        if (!this.value.trim()) {
            productIdInput.value = '';
            unitPriceInput.value = '';
            productDetails.textContent = '';
        }
    });

    row.querySelector('.remove-product').addEventListener('click', function() {
        if (document.querySelectorAll('.product-row').length > 1) {
            row.remove();
        } else {
            alert('At least one product is required');
        }
    });
}

function setupDenominationEvents() {
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.addEventListener('input', calculateCustomerPayment);
    });
    calculateCustomerPayment();
}

function calculateCustomerPayment() {
    let totalCustomerPayment = 0;
    
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        totalCustomerPayment += value * count;
    });
    
    document.getElementById('customer-total-payment').textContent = `₹${totalCustomerPayment.toFixed(2)}`;
    document.getElementById('id_amount_paid').value = totalCustomerPayment.toFixed(2);
}

function generateBill() {
    const form = document.getElementById('billingForm');
    const formData = new FormData(form);
    
    // ========== ESSENTIAL FRONTEND VALIDATION ==========
    
    // Only validate basic required fields and format issues
    const customerEmail = formData.get('customer_email');
    if (!customerEmail || customerEmail.trim() === '') {
        alert('Please enter a customer email address.');
        return;
    }
    
    // Check if at least one product is selected
    let hasProducts = false;
    const products = [];
    
    document.querySelectorAll('.product-row').forEach(row => {
        const productId = row.querySelector('.product-id-input').value;
        const quantity = row.querySelector('.quantity-input').value;
        
        if (productId && quantity && parseInt(quantity) > 0) {
            products.push({
                product_id: productId,
                quantity: parseInt(quantity)
            });
            hasProducts = true;
        }
    });
    
    if (!hasProducts) {
        alert('Please add at least one product to generate a bill.');
        return;
    }
    
    // Collect customer denominations
    const customerDenominations = {};
    let totalCustomerPayment = 0;
    
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[input.dataset.value] = count;
            totalCustomerPayment += value * count;
        }
    });
    
    const amountPaid = parseFloat(formData.get('amount_paid')) || 0;
    
    // Basic denomination matching check
    if (totalCustomerPayment > 0 && Math.abs(totalCustomerPayment - amountPaid) > 0.01) {
        alert(`Customer denominations total (₹${totalCustomerPayment.toFixed(2)}) must match amount paid (₹${amountPaid.toFixed(2)})`);
        return;
    }
    
    // Collect shop drawer denominations
    const denominations = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        denominations[input.dataset.value] = parseInt(input.value) || 0;
    });

    const billData = {
        customer_email: formData.get('customer_email'),
        amount_paid: parseFloat(formData.get('amount_paid')),
        products: products,
        denominations: denominations,
        customer_payment_denominations: customerDenominations
    };

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;

    fetch('/api/generate-bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(billData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayInvoice(data);
            if (data.customer_payment_denominations && Object.keys(data.customer_payment_denominations).length > 0) {
                console.log('Bill generated successfully! Customer denominations have been added to the shop drawer.');
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the bill');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayInvoice(data) {
    let changeBreakdownHtml = '';
    if (data.change_breakdown && data.change_breakdown.length > 0) {
        changeBreakdownHtml = displayChangeBreakdown(data.change_breakdown);
    }

    let itemsHtml = '';
    data.items.forEach(item => {
        const purchasePrice = (parseFloat(item.unit_price) * item.quantity).toFixed(2);
        const taxAmount = (parseFloat(purchasePrice) * parseFloat(item.tax_percentage) / 100).toFixed(2);
        const totalPrice = (parseFloat(purchasePrice) + parseFloat(taxAmount)).toFixed(2);
        
        itemsHtml += `
            <tr>
                <td>${item.product_id || item.name}</td>
                <td>₹${item.unit_price}</td>
                <td>${item.quantity}</td>
                <td>₹${purchasePrice}</td>
                <td>${item.tax_percentage}%</td>
                <td>₹${taxAmount}</td>
                <td>₹${totalPrice}</td>
            </tr>`;
    });

    const invoiceHtml = `
        <div class="invoice-section">
            <div class="text-center mb-4">
                <h4>INVOICE</h4>
                <p><strong>Purchase ID:</strong> ${data.purchase_id}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Customer Email:</strong> ${data.customer_email || 'Not provided'}</p>
            </div>
            
            <h6>Items Purchased:</h6>
            <div class="table-responsive mb-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>Purchase Price</th>
                            <th>Tax % for item</th>
                            <th>Tax payable for item</th>
                            <th>Total price of the item</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            </div>

            <div class="row">
                <div class="col-md-6">
                    ${changeBreakdownHtml}
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Bill Summary</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Total Price Without Tax:</td>
                                    <td class="text-end">₹${parseFloat(data.total_amount).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>Total Tax Payable:</td>
                                    <td class="text-end">₹${parseFloat(data.tax_amount).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Net Price of the Purchased item:</td>
                                    <td class="text-end">₹${parseFloat(data.total_amount + data.tax_amount).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Bill Amount (Rounded):</td>
                                    <td class="text-end">₹${parseFloat(data.grand_total).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold text-success">
                                    <td>Balance Payable to the customer:</td>
                                    <td class="text-end">₹${parseFloat(data.change_amount).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>Amount Paid:</td>
                                    <td class="text-end">₹${data.amount_paid}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-muted">Thank you for your purchase!</p>
                <p><small>Invoice has been sent to the customer's email address.</small></p>
            </div>
        </div>`;

    document.getElementById('invoice-content').innerHTML = invoiceHtml;
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();

    document.querySelectorAll('.denomination-count').forEach(input => {
        input.value = data.available_denominations[input.dataset.value] || 0;
    });

    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = data.customer_payment_denominations[input.dataset.value] || 0;
    });

    document.getElementById('customer-total-payment').textContent = `₹${data.total_customer_payment.toFixed(2)}`;

    resetForm();
}

function resetForm() {
    document.getElementById('billingForm').reset();
    const container = document.getElementById('product-container');
    const firstRow = container.querySelector('.product-row');
    container.innerHTML = '';
    container.appendChild(firstRow);
    firstRow.querySelectorAll('input').forEach(field => {
        if (field.type !== 'button') {
            field.value = field.type === 'number' ? '1' : '';
        }
    });
    firstRow.querySelector('.product-details').textContent = '';
    firstRow.querySelector('.unit-price').value = '';
    
    // Re-initialize product search for the reset row
    const productSearch = firstRow.querySelector('.product-search');
    if (productSearch) {
        setupProductSearch(productSearch);
    }
    
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = '0';
    });
    
    document.getElementById('customer-total-payment').textContent = '₹0.00';
    document.getElementById('id_amount_paid').value = '0.00';
}

function showDrawerStatus() {
    const currentDrawer = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        currentDrawer[value] = count;
    });
    
    const customerDenominations = {};
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[value] = count;
        }
    });
    
    let statusMessage = 'Current Drawer Status:\n';
    Object.keys(currentDrawer).forEach(value => {
        statusMessage += `₹${value}: ${currentDrawer[value]} notes\n`;
    });
    
    if (Object.keys(customerDenominations).length > 0) {
        statusMessage += '\nCustomer Payment:\n';
        Object.keys(customerDenominations).forEach(value => {
            statusMessage += `₹${value}: ${customerDenominations[value]} notes\n`;
        });
        const customerTotal = document.getElementById('customer-total-payment').textContent;
        statusMessage += `\nTotal Customer Payment: ${customerTotal}`;
    } else {
        statusMessage += '\nNo customer denominations entered yet.';
    }
    
    alert(statusMessage);
}

function refreshDrawerFromDatabase() {
    const statusIndicator = document.getElementById('drawer-status-indicator');
    if (statusIndicator) {
        statusIndicator.textContent = 'Refreshing...';
        statusIndicator.className = 'text-warning';
    }
    
    fetch('/api/update-drawer-realtime/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            customer_denominations: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateShopDrawerDisplay(data.current_drawer_status);
            
            if (statusIndicator) {
                statusIndicator.textContent = 'Refreshed';
                statusIndicator.className = 'text-success';
            }
            
            document.querySelectorAll('.customer-denomination-count').forEach(input => {
                input.value = '0';
            });
            
            document.getElementById('id_amount_paid').value = '0.00';
            document.getElementById('customer-total-payment').textContent = '₹0.00';
        } else {
            if (statusIndicator) {
                statusIndicator.textContent = 'Refresh Error';
                statusIndicator.className = 'text-danger';
            }
            alert('Refresh failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error refreshing drawer:', error);
        if (statusIndicator) {
            statusIndicator.textContent = 'Refresh Error';
            statusIndicator.className = 'text-danger';
        }
        alert('Refresh failed');
    })
    .finally(() => {
        setTimeout(() => {
            if (statusIndicator) {
                statusIndicator.textContent = 'Ready';
                statusIndicator.className = 'text-info';
            }
        }, 3000);
    });
}

function updateShopDrawerDisplay(drawerStatus) {
    Object.keys(drawerStatus).forEach(denomValue => {
        const drawerInput = document.querySelector(`.denomination-count[data-value="${denomValue}"]`);
        if (drawerInput) {
            const newCount = drawerStatus[denomValue].count;
            drawerInput.value = newCount;
        }
    });
}

function displayChangeBreakdown(changeBreakdown) {
    if (!changeBreakdown || changeBreakdown.length === 0) {
        return '<p class="text-muted">No change needed</p>';
    }
    
    let html = `
        <h6>Change Breakdown (Greedy Algorithm):</h6>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Denomination</th>
                        <th>Count</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>`;
    
    changeBreakdown.forEach(item => {
        html += `
            <tr class="table-success">
                <td>₹${item.value}</td>
                <td>${item.count}</td>
                <td>₹${item.total}</td>
            </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>`;
    
    return html;
}
</script>
{% endblock %}