{% extends 'base.html' %}

{% block title %}Billing - Create New Bill{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-calculator"></i> Create New Bill</h4>
                <small class="text-muted">Bill amounts are rounded to nearest rupee for accurate change calculation</small>
            </div>
            <div class="card-body">
                <form id="billingForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_customer_email" class="form-label">Customer Email *</label>
                        {{ form.customer_email }}
                    </div>

                    <div class="mb-4">
                        <h5>Products</h5>
                        <div id="product-container">
                            <div class="product-row" data-index="0">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Product ID</label>
                                        <select class="form-control product-select" name="product_id_0">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                                <option value="{{ product.product_id }}">{{ product.product_id }} - {{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control quantity-input" name="quantity_0" min="1" value="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Unit Price</label>
                                        <input type="text" class="form-control unit-price" readonly>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Action</label><br>
                                        <button type="button" class="btn btn-danger btn-sm remove-product">Remove</button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <small class="text-muted product-details"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-product" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>

                    <div class="mb-3">
                        <label for="id_amount_paid" class="form-label">Amount Paid *</label>
                        {{ form.amount_paid }}
                    </div>

                    <!-- Customer Denomination Input Section -->
                    <div class="mb-4 customer-denomination-section">
                        <h5><i class="fas fa-money-bill-wave"></i> Customer Payment Denominations</h5>
                        <div class="alert alert-info alert-sm">
                            <small><i class="fas fa-info-circle"></i> <strong>Preview Mode:</strong> Denominations shown here are for display only. Database will be updated only when the bill is successfully generated.</small>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Denomination</label>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Count</label>
                            </div>
                        </div>
                        {% for denomination in denominations %}
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">₹{{ denomination.value }}</label>
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control form-control-sm customer-denomination-count denomination-input" 
                                       data-value="{{ denomination.value }}" 
                                       value="0" min="0" placeholder="0">
                            </div>
                        </div>
                        {% endfor %}
                                        <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Total Customer Payment:</strong>
                    </div>
                    <div class="col-md-6">
                        <span id="customer-total-payment" class="fw-bold text-primary">₹0.00</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Balance Required:</strong>
                    </div>
                    <div class="col-md-6">
                        <span id="balance-required" class="fw-bold text-warning">₹0.00</span>
                    </div>
                </div>
                
                <!-- Real-time Shop Drawer Summary -->
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-calculator"></i> Real-time Drawer Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless">
                                <thead>
                                    <tr>
                                        <th>Denomination</th>
                                        <th>Original</th>
                                        <th>Customer</th>
                                        <th>New Total</th>
                                    </tr>
                                </thead>
                                <tbody id="drawer-summary-table">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-file-invoice"></i> Generate Bill
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card denomination-section">
            <div class="card-header">
                <h5><i class="fas fa-coins"></i> Shop Drawer Denominations</h5>
                <small class="text-muted">Shows preview of what drawer will look like after customer payment</small>
            </div>
            <div class="card-body">
                {% for denomination in denominations %}
                <div class="row mb-2">
                    <div class="col-6">
                        <label>₹{{ denomination.value }}</label>
                    </div>
                    <div class="col-6">
                        <input type="number" class="form-control form-control-sm denomination-count" 
                               data-value="{{ denomination.value }}" 
                               value="{{ denomination.count }}" min="0">
                    </div>
                </div>
                {% endfor %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Current shop drawer status for change calculation
                        </small>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="showDrawerStatus()">
                            <i class="fas fa-eye"></i> View Drawer Status
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="refreshDrawerFromDatabase()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-sync-alt"></i> 
                                <span id="drawer-status-indicator">Ready</span>
                            </small>
                            <div class="mt-1">
                                <small class="text-warning">
                                    <i class="fas fa-info-circle"></i> 
                                    Denominations are updated in database only when bill is generated
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Display Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> Invoice Generated
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoice-content">
                <!-- Invoice content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.preview-drawer {
    background-color: #fff3cd !important;
    border-color: #ffeaa7 !important;
    color: #856404 !important;
    animation: previewPulse 1s ease-in-out;
}

@keyframes previewPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.updated-drawer {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724 !important;
}

.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let productIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Add product functionality
    document.getElementById('add-product').addEventListener('click', function() {
        productIndex++;
        const container = document.getElementById('product-container');
        const newProductRow = container.querySelector('.product-row').cloneNode(true);
        
        // Update indices and clear values
        newProductRow.dataset.index = productIndex;
        newProductRow.querySelectorAll('select, input').forEach(field => {
            if (field.name) {
                field.name = field.name.replace(/_\d+/, '_' + productIndex);
            }
            if (field.type !== 'button') {
                field.value = field.type === 'number' ? '1' : '';
            }
        });
        
        container.appendChild(newProductRow);
        setupProductRowEvents(newProductRow);
    });

    // Setup events for existing rows
    document.querySelectorAll('.product-row').forEach(setupProductRowEvents);

    // Setup denomination calculation events
    setupDenominationEvents();
    
    // Initialize drawer summary table
    initializeDrawerSummaryTable();

    // Form submission
    document.getElementById('billingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateBill();
    });
});

function setupProductRowEvents(row) {
    // Product selection change
    const productSelect = row.querySelector('.product-select');
    const quantityInput = row.querySelector('.quantity-input');
    const unitPriceInput = row.querySelector('.unit-price');
    const productDetails = row.querySelector('.product-details');
    const totalPriceInput = row.querySelector('.total-price');
    
    productSelect.addEventListener('change', function() {
        if (this.value) {
            fetch(`/api/product/${this.value}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        unitPriceInput.value = '₹' + data.price;
                        productDetails.textContent = `${data.name} | Tax: ${data.tax}% | Stock: ${data.stock}`;
                    } else {
                        alert('Product not found');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching product details');
                });
        } else {
            unitPriceInput.value = '';
            productDetails.textContent = '';
        }
    });

    // Remove product
    const removeBtn = row.querySelector('.remove-product');
    removeBtn.addEventListener('click', function() {
        if (document.querySelectorAll('.product-row').length > 1) {
            row.remove();
        } else {
            alert('At least one product is required');
        }
    });
}

function setupDenominationEvents() {
    // Calculate totals when customer denominations change
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.addEventListener('input', calculateCustomerPayment);
        // Add event listener for when input is cleared
        input.addEventListener('change', handleCustomerDenominationChange);
    });
    
    // Calculate totals when amount paid changes
    document.getElementById('id_amount_paid').addEventListener('input', calculateCustomerPayment);
}

function calculateCustomerPayment() {
    let totalCustomerPayment = 0;
    
    // Calculate total from customer denominations
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        totalCustomerPayment += value * count;
    });
    
    // Update customer total payment display
    document.getElementById('customer-total-payment').textContent = `₹${totalCustomerPayment.toFixed(2)}`;
    
    // Calculate and display balance required
    const amountPaid = parseFloat(document.getElementById('id_amount_paid').value) || 0;
    const balanceRequired = Math.max(0, amountPaid - totalCustomerPayment);
    document.getElementById('balance-required').textContent = `₹${balanceRequired.toFixed(2)}`;
    
    // Auto-fill amount paid if customer denominations are entered
    if (totalCustomerPayment > 0) {
        document.getElementById('id_amount_paid').value = totalCustomerPayment.toFixed(2);
    }
    
    // Update shop drawer denominations in real-time
    updateShopDrawerFromCustomerPayment();
}

function generateBill() {
    const form = document.getElementById('billingForm');
    const formData = new FormData(form);
    
    // Validate customer denominations
    const customerDenominations = {};
    let totalCustomerPayment = 0;
    
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[input.dataset.value] = count;
            totalCustomerPayment += value * count;
        }
    });
    
    const amountPaid = parseFloat(formData.get('amount_paid')) || 0;
    
    // Check if customer denominations match amount paid
    if (totalCustomerPayment > 0 && Math.abs(totalCustomerPayment - amountPaid) > 0.01) {
        alert(`Customer denominations total (₹${totalCustomerPayment.toFixed(2)}) must match amount paid (₹${amountPaid.toFixed(2)})`);
        return;
    }
    
    // Collect product data
    const products = [];
    document.querySelectorAll('.product-row').forEach(row => {
        const productId = row.querySelector('.product-select').value;
        const quantity = row.querySelector('.quantity-input').value;
        
        if (productId && quantity && parseInt(quantity) > 0) {
            products.push({
                product_id: productId,
                quantity: parseInt(quantity)
            });
        }
    });

    // Collect denomination data
    const denominations = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        denominations[input.dataset.value] = parseInt(input.value) || 0;
    });

    if (products.length === 0) {
        alert('Please add at least one product');
        return;
    }

    const billData = {
        customer_email: formData.get('customer_email'),
        amount_paid: parseFloat(formData.get('amount_paid')),
        products: products,
        denominations: denominations,
        customer_payment_denominations: customerDenominations
    };

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;

    fetch('/api/generate-bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(billData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayInvoice(data);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the bill');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayInvoice(data) {
    let changeBreakdownHtml = '';
    if (data.change_breakdown && data.change_breakdown.length > 0) {
        changeBreakdownHtml = displayChangeBreakdown(data.change_breakdown);
    }

    let itemsHtml = '';
    data.items.forEach(item => {
        itemsHtml += `
            <tr>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>₹${item.unit_price}</td>
                <td>${item.tax_percentage}%</td>
                <td>₹${item.subtotal}</td>
            </tr>`;
    });
    
    // Show success message that database has been updated
    showDrawerUpdateNotification('Bill generated successfully! Database has been updated with customer denominations.', 'success');

    const invoiceHtml = `
        <div class="invoice-section">
            <div class="text-center mb-4">
                <h4>INVOICE</h4>
                <p><strong>Purchase ID:</strong> ${data.purchase_id}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            
            <h6>Items Purchased:</h6>
            <div class="table-responsive mb-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Tax</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            </div>

            <div class="row">
                <div class="col-md-6">
                    ${changeBreakdownHtml}
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Bill Summary</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Total Price Without Tax:</td>
                                    <td class="text-end">₹${data.total_amount}</td>
                                </tr>
                                <tr>
                                    <td>Total Tax Payable:</td>
                                    <td class="text-end">₹${data.tax_amount}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Net Price of the Purchased item:</td>
                                    <td class="text-end">₹${Math.round(data.grand_total)}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Bill Amount (Rounded):</td>
                                    <td class="text-end">₹${Math.round(data.grand_total)}</td>
                                </tr>
                                <tr class="text-muted">
                                    <td><small><i class="fas fa-info-circle"></i> Amount rounded to nearest rupee for change calculation</small></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>Customer Payment Denominations:</td>
                                    <td class="text-end">₹${data.total_customer_payment}</td>
                                </tr>
                                <tr>
                                    <td>Amount Paid:</td>
                                    <td class="text-end">₹${data.amount_paid}</td>
                                </tr>
                                <tr class="fw-bold text-success">
                                    <td>Balance Payable to the customer:</td>
                                    <td class="text-end">₹${Math.round(data.change_amount)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-calculator"></i> Transaction Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Customer Paid:</strong></td>
                                            <td class="text-end">₹${data.total_customer_payment}</td>
                                        </tr>
                                                                        <tr>
                                    <td><strong>Bill Amount (Rounded):</strong></td>
                                    <td class="text-end">₹${Math.round(data.grand_total)}</td>
                                </tr>
                                        <tr class="table-success">
                                            <td><strong>Change Given:</strong></td>
                                            <td class="text-end">₹${Math.round(data.change_amount)}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Denominations Used:</strong></td>
                                            <td class="text-end">${data.transaction_summary.denominations_used_for_change}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Change Given:</strong></td>
                                            <td class="text-end">₹${data.total_change_given}</td>
                                        </tr>
                                        <tr class="table-info">
                                            <td><strong>Status:</strong></td>
                                            <td class="text-end">${data.change_amount > 0 ? 'Change Given' : 'Exact Payment'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-muted">Thank you for your purchase!</p>
                <p><small>Invoice has been sent to the customer's email address.</small></p>
            </div>
        </div>`;

    document.getElementById('invoice-content').innerHTML = invoiceHtml;
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();

    // Update shop drawer denominations
    document.querySelectorAll('.denomination-count').forEach(input => {
        input.value = data.available_denominations[input.dataset.value] || 0;
    });

    // Update customer payment denominations
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = data.customer_payment_denominations[input.dataset.value] || 0;
    });

    // Update total payment and balance
    document.getElementById('customer-total-payment').textContent = `₹${data.total_customer_payment.toFixed(2)}`;
    document.getElementById('balance-required').textContent = `₹${data.balance_required.toFixed(2)}`;

    // Reset form
    document.getElementById('billingForm').reset();
    // Keep only one product row
    const container = document.getElementById('product-container');
    const firstRow = container.querySelector('.product-row');
    container.innerHTML = '';
    container.appendChild(firstRow);
    firstRow.querySelectorAll('select, input').forEach(field => {
        if (field.type !== 'button') {
            field.value = field.type === 'number' ? '1' : '';
        }
    });
    firstRow.querySelector('.product-details').textContent = '';
    firstRow.querySelector('.unit-price').value = '';
    
    // Reset customer denomination inputs
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = '0';
    });
    
    // Reset totals
    document.getElementById('customer-total-payment').textContent = '₹0.00';
    document.getElementById('balance-required').textContent = '₹0.00';
    
    // Reset drawer summary table
    initializeDrawerSummaryTable();
}

function showDrawerStatus() {
    // Show detailed information about the current drawer status and preview mode
    const currentDrawer = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        currentDrawer[value] = count;
    });
    
    const customerDenominations = {};
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[value] = count;
        }
    });
    
    let statusMessage = 'Current Drawer Status:\n';
    Object.keys(currentDrawer).forEach(value => {
        statusMessage += `₹${value}: ${currentDrawer[value]} notes\n`;
    });
    
    if (Object.keys(customerDenominations).length > 0) {
        statusMessage += '\nCustomer Payment Preview:\n';
        Object.keys(customerDenominations).forEach(value => {
            statusMessage += `₹${value}: +${customerDenominations[value]} notes (will be added when bill is generated)\n`;
        });
        statusMessage += '\nNote: This is preview mode. Database will be updated only when bill is generated.';
    } else {
        statusMessage += '\nNo customer denominations entered yet.';
    }
    
    alert(statusMessage);
}

function updateShopDrawerFromCustomerPayment() {
    // Get current shop drawer denominations
    const shopDrawerDenominations = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        shopDrawerDenominations[value] = count;
    });
    
    // Get customer payment denominations
    const customerDenominations = {};
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[value] = count;
        }
    });
    
    // IMPORTANT CHANGE: Only update display, NOT database
    // Update shop drawer display by adding customer denominations (for preview only)
    Object.keys(customerDenominations).forEach(denomValue => {
        const customerCount = customerDenominations[denomValue];
        const currentDrawerCount = shopDrawerDenominations[denomValue] || 0;
        const newTotal = currentDrawerCount + customerCount;
        
        // Update the shop drawer display (temporary, not saved to database)
        const drawerInput = document.querySelector(`.denomination-count[data-value="${denomValue}"]`);
        if (drawerInput) {
            drawerInput.value = newTotal;
            // Add visual feedback to show this is a preview
            drawerInput.classList.add('preview-drawer');
            setTimeout(() => {
                drawerInput.classList.remove('preview-drawer');
            }, 1000);
        }
    });
    
    // Update the real-time drawer summary table
    updateDrawerSummaryTable(shopDrawerDenominations, customerDenominations);
    
    // Update status indicator to show this is preview mode
    updateDrawerStatusIndicator('Preview Mode');
    
    // IMPORTANT: Do NOT update database in real-time anymore
    // Only update display for customer to see what the drawer would look like
    // Database update happens only when generateBill() is called
    
    // Show visual feedback that this is preview only
    showDrawerUpdateNotification('Preview mode - Database will be updated when bill is generated', 'info');
}

function showDrawerUpdateNotification(message = 'Shop drawer updated with customer denominations', type = 'info') {
    // Create or update notification
    let notification = document.getElementById('drawer-update-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'drawer-update-notification';
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'sync-alt'}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (notification && notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    } else {
        // Update existing notification
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'sync-alt'}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
    }
}

function initializeDrawerSummaryTable() {
    // Get current shop drawer denominations
    const shopDrawerDenominations = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        shopDrawerDenominations[value] = count;
    });
    
    // Initialize with empty customer denominations
    updateDrawerSummaryTable(shopDrawerDenominations, {});
}

function updateDrawerStatusIndicator(status = 'Updated') {
    const statusIndicator = document.getElementById('drawer-status-indicator');
    if (statusIndicator) {
        statusIndicator.textContent = status;
        statusIndicator.className = 'text-success';
        
        // Reset to ready after 2 seconds
        setTimeout(() => {
            statusIndicator.textContent = 'Ready';
            statusIndicator.className = 'text-info';
        }, 2000);
    }
}

function updateDrawerInDatabase(customerDenominations) {
    // IMPORTANT CHANGE: This function is no longer used for real-time updates
    // It's kept for compatibility but now only updates the display preview
    // Database updates happen only when generateBill() is called
    
    // Only update if there are customer denominations
    if (Object.keys(customerDenominations).length === 0) return;
    
    // Update status to show preview mode
    const statusIndicator = document.getElementById('drawer-status-indicator');
    if (statusIndicator) {
        statusIndicator.textContent = 'Preview Mode';
        statusIndicator.className = 'text-info';
    }
    
    // Call API to get preview display (no database update)
    fetch('/api/update-drawer-realtime/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            customer_denominations: customerDenominations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status to show preview mode
            if (statusIndicator) {
                statusIndicator.textContent = 'Preview Active';
                statusIndicator.className = 'text-info';
            }
            
            // Update the shop drawer display with projected values (not actual database values)
            if (data.projected_drawer_status) {
                updateShopDrawerDisplay(data.projected_drawer_status);
            }
            
            // Show info notification that this is preview only
            showDrawerUpdateNotification('Preview mode active - Database will be updated when bill is generated', 'info');
        } else {
            // Show error
            if (statusIndicator) {
                statusIndicator.textContent = 'Preview Error';
                statusIndicator.className = 'text-danger';
            }
            showDrawerUpdateNotification('Preview failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating preview:', error);
        if (statusIndicator) {
            statusIndicator.textContent = 'Preview Error';
            statusIndicator.className = 'text-danger';
        }
        showDrawerUpdateNotification('Preview failed', 'danger');
    })
    .finally(() => {
        // Reset status after 3 seconds
        setTimeout(() => {
            if (statusIndicator) {
                statusIndicator.textContent = 'Ready';
                statusIndicator.className = 'text-info';
            }
        }, 3000);
    });
}

function updateShopDrawerDisplay(drawerStatus) {
    // Update shop drawer inputs with actual database values
    Object.keys(drawerStatus).forEach(denomValue => {
        const drawerInput = document.querySelector(`.denomination-count[data-value="${denomValue}"]`);
        if (drawerInput) {
            const newCount = drawerStatus[denomValue].count;
            drawerInput.value = newCount;
        }
    });
}

function handleCustomerDenominationChange() {
    // This function handles when customer denominations are changed or cleared
    // We need to recalculate the shop drawer based on current customer input
    const customerDenominations = {};
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[value] = count;
        }
    });
    
    // Update the drawer summary table
    const originalDrawer = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        originalDrawer[value] = count;
    });
    
    updateDrawerSummaryTable(originalDrawer, customerDenominations);
}

function refreshDrawerFromDatabase() {
    // Update status to show refresh in progress
    const statusIndicator = document.getElementById('drawer-status-indicator');
    if (statusIndicator) {
        statusIndicator.textContent = 'Refreshing...';
        statusIndicator.className = 'text-warning';
    }
    
    // Call API to get current drawer status (no customer denominations for refresh)
    fetch('/api/update-drawer-realtime/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            customer_denominations: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the shop drawer display with actual database values
            updateShopDrawerDisplay(data.current_drawer_status);
            
            // Update status to show success
            if (statusIndicator) {
                statusIndicator.textContent = 'Refreshed';
                statusIndicator.className = 'text-success';
            }
            
            // Show success notification
            showDrawerUpdateNotification('Drawer refreshed from database!', 'success');
            
            // Reset customer denominations to clear any temporary changes
            document.querySelectorAll('.customer-denomination-count').forEach(input => {
                input.value = '0';
            });
            
            // Recalculate totals
            calculateCustomerPayment();
            
            // Reset drawer summary table
            initializeDrawerSummaryTable();
        } else {
            // Show error
            if (statusIndicator) {
                statusIndicator.textContent = 'Refresh Error';
                statusIndicator.className = 'text-danger';
            }
            showDrawerUpdateNotification('Refresh failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error refreshing drawer:', error);
        if (statusIndicator) {
            statusIndicator.textContent = 'Refresh Error';
            statusIndicator.className = 'text-danger';
        }
        showDrawerUpdateNotification('Refresh failed', 'danger');
    })
    .finally(() => {
        // Reset status after 3 seconds
        setTimeout(() => {
            if (statusIndicator) {
                statusIndicator.textContent = 'Ready';
                statusIndicator.className = 'text-info';
            }
        }, 3000);
    });
}

function updateDrawerSummaryTable(originalDrawer, customerDenominations) {
    const summaryTable = document.getElementById('drawer-summary-table');
    if (!summaryTable) return;
    
    let html = '';
    
    // Get all denomination values
    const allDenominations = new Set([
        ...Object.keys(originalDrawer),
        ...Object.keys(customerDenominations)
    ]);
    
    // Sort denominations by value (highest first)
    const sortedDenominations = Array.from(allDenominations).sort((a, b) => parseFloat(b) - parseFloat(a));
    
    sortedDenominations.forEach(denomValue => {
        const originalCount = originalDrawer[denomValue] || 0;
        const customerCount = customerDenominations[denomValue] || 0;
        const newTotal = originalCount + customerCount;
        
        // Only show rows where there's activity
        if (customerCount > 0 || originalCount > 0) {
            const rowClass = customerCount > 0 ? 'table-success' : '';
            html += `
                <tr class="${rowClass}">
                    <td>₹${denomValue}</td>
                    <td>${originalCount}</td>
                    <td class="text-success">${customerCount > 0 ? '+' + customerCount : '-'}</td>
                    <td class="fw-bold">${newTotal}</td>
                </tr>`;
        }
    });
    
    if (html === '') {
        html = '<tr><td colspan="4" class="text-center text-muted">No denominations entered yet</td></tr>';
    }
    
    summaryTable.innerHTML = html;
}

function displayChangeBreakdown(changeBreakdown) {
    if (!changeBreakdown || changeBreakdown.length === 0) {
        return '<p class="text-muted">No change needed</p>';
    }
    
    let html = `
        <h6>Change Breakdown (Greedy Algorithm):</h6>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Denomination</th>
                        <th>Count</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>`;
    
    changeBreakdown.forEach(item => {
        html += `
            <tr class="table-success">
                <td>₹${item.value}</td>
                <td>${item.count}</td>
                <td>₹${item.total}</td>
            </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>`;
    
    return html;
}

</script>
{% endblock %}