{% extends 'base.html' %}

{% block title %}Billing - Create New Bill{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-calculator"></i> Create New Bill</h4>
            </div>
            <div class="card-body">
                <form id="billingForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_customer_email" class="form-label">Customer Email *</label>
                        {{ form.customer_email }}
                    </div>

                    <div class="mb-4">
                        <h5>Products</h5>
                        <div id="product-container">
                            <div class="product-row" data-index="0">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Product ID</label>
                                        <select class="form-control product-select" name="product_id_0">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                                <option value="{{ product.product_id }}">{{ product.product_id }} - {{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control quantity-input" name="quantity_0" min="1" value="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Unit Price</label>
                                        <input type="text" class="form-control unit-price" readonly>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Action</label><br>
                                        <button type="button" class="btn btn-danger btn-sm remove-product">Remove</button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <small class="text-muted product-details"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-product" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>


                    <!-- Customer Denomination Input Section -->
                    <div class="mb-4 customer-denomination-section">
                        <h5><i class="fas fa-money-bill-wave"></i> Customer Payment Denominations</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Denomination</label>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Count</label>
                            </div>
                        </div>
                        {% for denomination in denominations %}
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">₹{{ denomination.value }}</label>
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control form-control-sm customer-denomination-count denomination-input" 
                                       data-value="{{ denomination.value }}" 
                                       value="0" min="0" >
                            </div>
                        </div>
                        {% endfor %}
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <strong>Customer Payment Total: <span id="customer-total-payment">₹0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_amount_paid" class="form-label">Amount Paid *</label>
                        {{ form.amount_paid }} 
                        <div class="form-text">
                            <small class="text-muted">This will be automatically calculated from customer denominations above</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-file-invoice"></i> Generate Bill
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card denomination-section">
            <div class="card-header">
                <h5><i class="fas fa-coins"></i> Shop Drawer Denominations</h5>
                <small class="text-muted">Current shop drawer status for change calculation</small>
            </div>
            <div class="card-body">
                {% for denomination in denominations %}
                <div class="row mb-2">
                    <div class="col-6">
                        <label>₹{{ denomination.value }}</label>
                    </div>
                    <div class="col-6">
                        <input type="number" class="form-control form-control-sm denomination-count" 
                               data-value="{{ denomination.value }}" 
                               value="{{ denomination.count }}" min="0">
                    </div>
                </div>
                {% endfor %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Current shop drawer status for change calculation
                        </small>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="showDrawerStatus()">
                            <i class="fas fa-eye"></i> View Drawer Status
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="refreshDrawerFromDatabase()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-sync-alt"></i> 
                                <span id="drawer-status-indicator">Ready</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Display Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> Invoice Generated
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoice-content">
                <!-- Invoice content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let productIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Add product functionality
    document.getElementById('add-product').addEventListener('click', function() {
        productIndex++;
        const container = document.getElementById('product-container');
        const newProductRow = container.querySelector('.product-row').cloneNode(true);
        
        // Update indices and clear values
        newProductRow.dataset.index = productIndex;
        newProductRow.querySelectorAll('select, input').forEach(field => {
            if (field.name) {
                field.name = field.name.replace(/_\d+/, '_' + productIndex);
            }
            if (field.type !== 'button') {
                field.value = field.type === 'number' ? '1' : '';
            }
        });
        
        container.appendChild(newProductRow);
        setupProductRowEvents(newProductRow);
    });

    // Setup events for existing rows
    document.querySelectorAll('.product-row').forEach(setupProductRowEvents);

    // Setup denomination calculation events
    setupDenominationEvents();

    // Form submission
    document.getElementById('billingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateBill();
    });
});

function setupProductRowEvents(row) {
    // Product selection change
    const productSelect = row.querySelector('.product-select');
    const quantityInput = row.querySelector('.quantity-input');
    const unitPriceInput = row.querySelector('.unit-price');
    const productDetails = row.querySelector('.product-details');
    const totalPriceInput = row.querySelector('.total-price');
    
    productSelect.addEventListener('change', function() {
        if (this.value) {
            fetch(`/api/product/${this.value}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        unitPriceInput.value = '₹' + data.price;
                        productDetails.textContent = `${data.name} | Tax: ${data.tax}% | Stock: ${data.stock}`;
                    } else {
                        alert('Product not found');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching product details');
                });
        } else {
            unitPriceInput.value = '';
            productDetails.textContent = '';
        }
    });

    // Remove product
    const removeBtn = row.querySelector('.remove-product');
    removeBtn.addEventListener('click', function() {
        if (document.querySelectorAll('.product-row').length > 1) {
            row.remove();
        } else {
            alert('At least one product is required');
        }
    });
}

function setupDenominationEvents() {
    // Calculate totals when customer denominations change
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.addEventListener('input', calculateCustomerPayment);
        input.addEventListener('change', handleCustomerDenominationChange);
    });
    
    // Calculate totals when amount paid changes (manual override)
    document.getElementById('id_amount_paid').addEventListener('input', function() {
        // If user manually changes amount paid, recalculate customer denominations
        const amountPaid = parseFloat(this.value) || 0;
        const customerTotal = parseFloat(document.getElementById('customer-total-payment').textContent.replace('₹', '')) || 0;
        
        // Only recalculate if there's a significant difference
        if (Math.abs(amountPaid - customerTotal) > 0.01) {
            // User manually changed amount paid, don't auto-update from denominations
            // But still show the customer total
        }
    });
    
    // Initial calculation
    calculateCustomerPayment();
}

function calculateCustomerPayment() {
    let totalCustomerPayment = 0;
    
    // Calculate total from customer denominations
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        totalCustomerPayment += value * count;
    });
    
    // Update customer total payment display
    document.getElementById('customer-total-payment').textContent = `₹${totalCustomerPayment.toFixed(2)}`;
    
    // Auto-fill amount paid with customer denominations total
    document.getElementById('id_amount_paid').value = totalCustomerPayment.toFixed(2);
    
    // Calculate and display balance required (if there's a bill total)
    const amountPaid = totalCustomerPayment;
    // Note: Balance calculation would need bill total, which is calculated separately
    // For now, we just show the customer payment total
}

function generateBill() {
    const form = document.getElementById('billingForm');
    const formData = new FormData(form);
    
    // Validate customer denominations
    const customerDenominations = {};
    let totalCustomerPayment = 0;
    
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = parseFloat(input.dataset.value);
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[input.dataset.value] = count;
            totalCustomerPayment += value * count;
        }
    });
    
    const amountPaid = parseFloat(formData.get('amount_paid')) || 0;
    
    // Check if customer denominations match amount paid
    if (totalCustomerPayment > 0 && Math.abs(totalCustomerPayment - amountPaid) > 0.01) {
        alert(`Customer denominations total (₹${totalCustomerPayment.toFixed(2)}) must match amount paid (₹${amountPaid.toFixed(2)})`);
        return;
    }
    
    // Collect product data
    const products = [];
    document.querySelectorAll('.product-row').forEach(row => {
        const productId = row.querySelector('.product-select').value;
        const quantity = row.querySelector('.quantity-input').value;
        
        if (productId && quantity && parseInt(quantity) > 0) {
            products.push({
                product_id: productId,
                quantity: parseInt(quantity)
            });
        }
    });

    // Collect denomination data
    const denominations = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        denominations[input.dataset.value] = parseInt(input.value) || 0;
    });

    if (products.length === 0) {
        alert('Please add at least one product');
        return;
    }

    const billData = {
        customer_email: formData.get('customer_email'),
        amount_paid: parseFloat(formData.get('amount_paid')),
        products: products,
        denominations: denominations,
        customer_payment_denominations: customerDenominations
    };
    


    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;

    fetch('/api/generate-bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(billData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayInvoice(data);
            // Show success message about customer denominations being updated
            if (data.customer_payment_denominations && Object.keys(data.customer_payment_denominations).length > 0) {
                alert('Bill generated successfully! Customer denominations have been added to the shop drawer.');
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the bill');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayInvoice(data) {
    let changeBreakdownHtml = '';
    if (data.change_breakdown && data.change_breakdown.length > 0) {
        changeBreakdownHtml = displayChangeBreakdown(data.change_breakdown);
    }

    let itemsHtml = '';
    data.items.forEach(item => {
        const purchasePrice = (parseFloat(item.unit_price) * item.quantity).toFixed(2);
        const taxAmount = (parseFloat(purchasePrice) * parseFloat(item.tax_percentage) / 100).toFixed(2);
        const totalPrice = (parseFloat(purchasePrice) + parseFloat(taxAmount)).toFixed(2);
        
        itemsHtml += `
            <tr>
                <td>${item.product_id || item.name}</td>
                <td>₹${item.unit_price}</td>
                <td>${item.quantity}</td>
                <td>₹${purchasePrice}</td>
                <td>${item.tax_percentage}%</td>
                <td>₹${taxAmount}</td>
                <td>₹${totalPrice}</td>
            </tr>`;
    });

    const invoiceHtml = `
        <div class="invoice-section">
            <div class="text-center mb-4">
                <h4>INVOICE</h4>
                <p><strong>Purchase ID:</strong> ${data.purchase_id}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            
            <h6>Items Purchased:</h6>
            <div class="table-responsive mb-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>Purchase Price</th>
                            <th>Tax % for item</th>
                            <th>Tax payable for item</th>
                            <th>Total price of the item</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            </div>

            <div class="row">
                <div class="col-md-6">
                    ${changeBreakdownHtml}
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Bill Summary</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Total Price Without Tax:</td>
                                    <td class="text-end">₹${parseFloat(data.total_amount).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>Total Tax Payable:</td>
                                    <td class="text-end">₹${parseFloat(data.tax_amount).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Net Price of the Purchased item:</td>
                                    <td class="text-end">₹${parseFloat(data.total_amount + data.tax_amount).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Bill Amount (Rounded):</td>
                                    <td class="text-end">₹${parseFloat(data.grand_total).toFixed(2)}</td>
                                </tr>
                                <tr class="fw-bold text-success">
                                    <td>Balance Payable to the customer:</td>
                                    <td class="text-end">₹${parseFloat(data.change_amount).toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-muted">Thank you for your purchase!</p>
                <p><small>Invoice has been sent to the customer's email address.</small></p>
            </div>
        </div>`;

    document.getElementById('invoice-content').innerHTML = invoiceHtml;
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();

    // Update shop drawer denominations
    document.querySelectorAll('.denomination-count').forEach(input => {
        input.value = data.available_denominations[input.dataset.value] || 0;
    });

    // Update customer payment denominations
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = data.customer_payment_denominations[input.dataset.value] || 0;
    });

    // Update total payment and balance
    document.getElementById('customer-total-payment').textContent = `₹${data.total_customer_payment.toFixed(2)}`;
    document.getElementById('balance-required').textContent = `₹${data.balance_required.toFixed(2)}`;

    // Reset form
    document.getElementById('billingForm').reset();
    // Keep only one product row
    const container = document.getElementById('product-container');
    const firstRow = container.querySelector('.product-row');
    container.innerHTML = '';
    container.appendChild(firstRow);
    firstRow.querySelectorAll('select, input').forEach(field => {
        if (field.type !== 'button') {
            field.value = field.type === 'number' ? '1' : '';
        }
    });
    firstRow.querySelector('.product-details').textContent = '';
    firstRow.querySelector('.unit-price').value = '';
    
    // Reset customer denomination inputs
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        input.value = '0';
    });
    
    // Reset totals
    document.getElementById('customer-total-payment').textContent = '₹0.00';
    document.getElementById('id_amount_paid').value = '0.00';
}

function showDrawerStatus() {
    // Show detailed information about the current drawer status
    const currentDrawer = {};
    document.querySelectorAll('.denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        currentDrawer[value] = count;
    });
    
    const customerDenominations = {};
    document.querySelectorAll('.customer-denomination-count').forEach(input => {
        const value = input.dataset.value;
        const count = parseInt(input.value) || 0;
        if (count > 0) {
            customerDenominations[value] = count;
        }
    });
    
    let statusMessage = 'Current Drawer Status:\n';
    Object.keys(currentDrawer).forEach(value => {
        statusMessage += `₹${value}: ${currentDrawer[value]} notes\n`;
    });
    
    if (Object.keys(customerDenominations).length > 0) {
        statusMessage += '\nCustomer Payment:\n';
        Object.keys(customerDenominations).forEach(value => {
            statusMessage += `₹${value}: ${customerDenominations[value]} notes\n`;
        });
        const customerTotal = document.getElementById('customer-total-payment').textContent;
        statusMessage += `\nTotal Customer Payment: ${customerTotal}`;
    } else {
        statusMessage += '\nNo customer denominations entered yet.';
    }
    
    alert(statusMessage);
}

function handleCustomerDenominationChange() {
    // This function handles when customer denominations are changed or cleared
    // Recalculate totals
    calculateCustomerPayment();
    
    // Clear any manual amount paid if user clears all denominations
    const totalCustomerPayment = parseFloat(document.getElementById('customer-total-payment').textContent.replace('₹', '')) || 0;
    if (totalCustomerPayment === 0) {
        document.getElementById('id_amount_paid').value = '0.00';
    }
}

function refreshDrawerFromDatabase() {
    // Update status to show refresh in progress
    const statusIndicator = document.getElementById('drawer-status-indicator');
    if (statusIndicator) {
        statusIndicator.textContent = 'Refreshing...';
        statusIndicator.className = 'text-warning';
    }
    
    // Call API to get current drawer status
    fetch('/api/update-drawer-realtime/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            customer_denominations: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the shop drawer display with actual database values
            updateShopDrawerDisplay(data.current_drawer_status);
            
            // Update status to show success
            if (statusIndicator) {
                statusIndicator.textContent = 'Refreshed';
                statusIndicator.className = 'text-success';
            }
            
            // Reset customer denominations to clear any temporary changes
            document.querySelectorAll('.customer-denomination-count').forEach(input => {
                input.value = '0';
            });
            
            // Reset amount paid and totals
            document.getElementById('id_amount_paid').value = '0.00';
            document.getElementById('customer-total-payment').textContent = '₹0.00';
        } else {
            // Show error
            if (statusIndicator) {
                statusIndicator.textContent = 'Refresh Error';
                statusIndicator.className = 'text-danger';
            }
            alert('Refresh failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error refreshing drawer:', error);
        if (statusIndicator) {
            statusIndicator.textContent = 'Refresh Error';
            statusIndicator.className = 'text-danger';
        }
        alert('Refresh failed');
    })
    .finally(() => {
        // Reset status after 3 seconds
        setTimeout(() => {
            if (statusIndicator) {
                statusIndicator.textContent = 'Ready';
                statusIndicator.className = 'text-info';
            }
        }, 3000);
    });
}

function updateShopDrawerDisplay(drawerStatus) {
    // Update shop drawer inputs with actual database values
    Object.keys(drawerStatus).forEach(denomValue => {
        const drawerInput = document.querySelector(`.denomination-count[data-value="${denomValue}"]`);
        if (drawerInput) {
            const newCount = drawerStatus[denomValue].count;
            drawerInput.value = newCount;
        }
    });
}

function displayChangeBreakdown(changeBreakdown) {
    if (!changeBreakdown || changeBreakdown.length === 0) {
        return '<p class="text-muted">No change needed</p>';
    }
    
    let html = `
        <h6>Change Breakdown (Greedy Algorithm):</h6>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Denomination</th>
                        <th>Count</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>`;
    
    changeBreakdown.forEach(item => {
        html += `
            <tr class="table-success">
                <td>₹${item.value}</td>
                <td>${item.count}</td>
                <td>₹${item.total}</td>
            </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>`;
    
    return html;
}

</script>
{% endblock %}